machine:
  services:
    - docker

dependencies:
  cache_directories:
    - "~/docker"
    - "~/.apt-cache"

  pre:
    - mkdir -p $HOME/docker

  override:
    - if [[ -e "$HOME/docker/cache.tar" ]]; then docker load --input $HOME/docker/cache.tar; fi :
        timeout: 6000
    - docker images
    - ./Simple_Prep_docker jessie 20170410T000000Z && repronimtag=repronim:$(docker images repronim | tail -n 1 | awk '{print $2}') && "echo 'export repronimtag=$repronimtag' >> ~/.circlerc" :
        timeout: 6000
    - echo $repronimtag
    - docker save -o $HOME/docker/cache.tar $repronimtag :
        timeout: 6000

test:
  override:
    - echo $repronimtag
    - docker run -it --rm -v $HOME/simple_workflow:/opt/repronim/simple_workflow/scripts/output $repronimtag python run_demo_workflow.py --key 11an55u9t2TAf0EV2pHN0vOd8Ww2Gie-tHp9xGULh_dA -n 2 :
       timeout: 4000
    - docker run -it --rm -v $HOME/simple_workflow:/opt/repronim/simple_workflow/scripts/output $repronimtag python check_output.py | tee ~/log.txt :
       timeout: 4000
    - cat ~/log.txt && if grep -q "MATCH" ~/log.txt; then true; else false; fi

general:
  artifacts:
    - "~/log.txt"
    - "~/simple_workflow/ActualOutput.csv"
    - "~/simple_workflow/Difference.csv"
    - "~/simple_workflow/ExpectedOutput.csv"
